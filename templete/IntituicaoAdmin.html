<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instituição - Admin Integrado</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    
    <style>
      #map { width: 100%; height: 400px; border-radius: 10px; border: 1px solid #ddd; z-index: 1; }
      .hidden-field { display: none; }
      .table-hover tbody tr:hover { background-color: #f1f8e9; cursor: pointer; }
      .btn-action { margin: 0 2px; }
      
      
    </style>
  </head>

  <body>
    <div id="sidebar-container"></div>
    <div class="container-fluid p-4">
      <h3 class="mb-4 text-success fw-bold"><i class="bi bi-building-gear"></i> Gerenciar Instituições</h3>
      
      <div class="row">
        <div class="col-lg-7">
          <div class="card p-4 mb-3 shadow-sm border-0">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
              <div class="input-group" style="max-width: 300px;">
                <input type="text" id="buscar" class="form-control" placeholder="Buscar por nome..." onkeyup="filtrarTabela()"/>
                <button class="btn btn-outline-success"><i class="bi bi-search"></i></button>
              </div>

              <button class="btn btn-success" onclick="abrirModalCriacao()">
                <i class="bi bi-plus-lg"></i> Nova Instituição
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle text-center">
                <thead class="table-light">
                  <tr>
                    <th>Cód.</th>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Telefone</th>
                    <th>Endereço</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="tabelaInstituicoes">
                  </tbody>
              </table>
            </div>
            
            <div id="loadingSpinner" class="text-center mt-3 d-none">
                <div class="spinner-border text-success" role="status"></div>
            </div>
            <div id="msgVazio" class="text-center text-muted mt-3 d-none">Nenhuma instituição encontrada.</div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="card p-3 shadow-sm border-0">
            <h5 class="text-success fw-bold mb-2">Localização</h5>
            <div id="map"></div>
            <small class="text-muted mt-2" id="statusMapa">
                <i class="bi bi-info-circle"></i> Clique no ícone de localização na tabela para buscar o endereço no mapa.
            </small>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalForm" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-3">
          <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 id="tituloModal" class="modal-title text-success fw-bold">Adicionar Instituição</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="formInstituicao" onsubmit="salvarInstituicao(event)">
              <input type="hidden" id="editId" value=""> <div class="modal-body">
                <h6 class="text-secondary border-bottom pb-2">Dados Gerais</h6>
                <div class="row g-2 mb-3">
                  <div class="col-md-3">
                    <label class="form-label">Código</label>
                    <input type="number" class="form-control" id="codigo" required />
                  </div>
                  <div class="col-md-5">
                    <label class="form-label">Nome</label>
                    <input type="text" class="form-control" id="nome" required />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Telefone</label>
                    <input type="text" class="form-control" id="telefone" placeholder="(xx) xxxx-xxxx" />
                  </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tipo de Instituição</label>
                    <select class="form-select" id="tipoSelect" required onchange="toggleCamposEspecificos()">
                        <option value="" selected disabled>Selecione...</option>
                        <option value="creche">Creche</option>
                        <option value="escola">Escola</option>
                        <option value="hotel">Hotel</option>
                    </select>
                </div>

                <div id="camposCreche" class="hidden-field bg-light p-3 rounded mb-3 border">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label>Idade Máxima (Meses)</label>
                            <input type="number" class="form-control" id="crecheIdade">
                        </div>
                        <div class="col-md-6">
                            <label>Capacidade</label>
                            <input type="number" class="form-control" id="crecheCapacidade">
                        </div>
                    </div>
                </div>

                <div id="camposEscola" class="hidden-field bg-light p-3 rounded mb-3 border">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label>Nº Matrículas</label>
                            <input type="number" class="form-control" id="escolaMatriculas">
                        </div>
                        <div class="col-md-6">
                            <label>Turno</label>
                            <select class="form-select" id="escolaTurno">
                                <option value="Manhã">Manhã</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Integral">Integral</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="camposHotel" class="hidden-field bg-light p-3 rounded mb-3 border">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label>Nº Quartos</label>
                            <input type="number" class="form-control" id="hotelQuartos">
                        </div>
                        <div class="col-md-6">
                            <label>Estrelas (1-5)</label>
                            <input type="number" class="form-control" id="hotelEstrelas" min="1" max="5">
                        </div>
                    </div>
                </div>

                <h6 class="text-secondary border-bottom pb-2 mt-3">Endereço</h6>
                <div class="row g-2">
                  <div class="col-md-3">
                    <label class="form-label text-muted small">CEP</label>
                    <input type="text" class="form-control" id="cep" placeholder="00000-000" required />
                  </div>
                  <div class="col-md-7">
                    <label class="form-label text-muted small">Rua</label>
                    <input type="text" class="form-control" id="rua" placeholder="Rua" required />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label text-muted small">Nº</label>
                    <input type="text" class="form-control" id="numero" placeholder="Nº" required />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label text-muted small">Bairro</label>
                    <input type="text" class="form-control" id="bairro" placeholder="Bairro" required />
                  </div>
                  <div class="col-md-5">
                    <label class="form-label text-muted small">Cidade</label>
                    <input type="text" class="form-control" id="cidade" placeholder="Cidade" required />
                  </div>
                  
                  <div class="col-md-3">
                    <label class="form-label text-muted small">Estado</label>
                    <select class="form-select" id="estado" required>
                        <option value="" disabled selected>UF</option>
                        <option value="AC">AC</option>
                        <option value="AL">AL</option>
                        <option value="AP">AP</option>
                        <option value="AM">AM</option>
                        <option value="BA">BA</option>
                        <option value="CE">CE</option>
                        <option value="DF">DF</option>
                        <option value="ES">ES</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="MT">MT</option>
                        <option value="MS">MS</option>
                        <option value="MG">MG</option>
                        <option value="PA">PA</option>
                        <option value="PB">PB</option>
                        <option value="PR">PR</option>
                        <option value="PE">PE</option>
                        <option value="PI">PI</option>
                        <option value="RJ">RJ</option>
                        <option value="RN">RN</option>
                        <option value="RS">RS</option>
                        <option value="RO">RO</option>
                        <option value="RR">RR</option>
                        <option value="SC">SC</option>
                        <option value="SP">SP</option>
                        <option value="SE">SE</option>
                        <option value="TO">TO</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success px-4">Salvar</button>
              </div>
            </form>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editIndex" />
            <input type="text" class="form-control mb-2" id="Nome" placeholder="Nome" required />
            <input type="text" class="form-control mb-2" id="Tipo_da_instituição" placeholder="Tipo_da_instituição" required />
            <input type="text" class="form-control mb-2" id="Endereço" placeholder="Endereço" required />
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
    <script src="../scriptTemplete/carregarSidebar.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // CONFIGURAÇÃO DA API
        const API_URL = "http://localhost:8080/api/instituicoes";
        
        let instituicoesCache = [];
        let modalInstance;
        let map;
        let currentMarker = null; // Para controlar o pino no mapa

        document.addEventListener('DOMContentLoaded', () => {
            modalInstance = new bootstrap.Modal(document.getElementById('modalForm'));
            initMap();
            carregarDadosDoBanco();
        });

        // --- 1. Integração com Backend (GET) ---
        async function carregarDadosDoBanco() {
            const tbody = document.getElementById('tabelaInstituicoes');
            const spinner = document.getElementById('loadingSpinner');
            const msgVazio = document.getElementById('msgVazio');

            tbody.innerHTML = '';
            spinner.classList.remove('d-none');
            msgVazio.classList.add('d-none');

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Erro na API");
                
                const dadosBrutos = await response.json();
                
                console.log("DADOS RECEBIDOS:", dadosBrutos); 

                instituicoesCache = dadosBrutos.map(inst => normalizarDados(inst));

                spinner.classList.add('d-none');
                renderizarTabela(instituicoesCache);

            } catch (error) {
                console.error("Erro ao conectar:", error);
                spinner.classList.add('d-none');
                tbody.innerHTML = `<tr><td colspan="6" class="text-danger">Erro ao carregar dados.</td></tr>`;
            }
        }

        function normalizarDados(inst) {
            let tipo = 'outro';
            let detalhes = {};

            if (inst.idadeMaximaAtendidaMeses !== undefined && inst.idadeMaximaAtendidaMeses !== null) {
                tipo = 'creche';
                detalhes = { idadeMax: inst.idadeMaximaAtendidaMeses, capacidade: inst.capacidade };
            } else if (inst.numeroMatriculas !== undefined && inst.numeroMatriculas !== null) {
                tipo = 'escola';
                detalhes = { matriculas: inst.numeroMatriculas, turno: inst.turno };
            } else if (inst.numeroQuartos !== undefined && inst.numeroQuartos !== null) {
                tipo = 'hotel';
                detalhes = { quartos: inst.numeroQuartos, estrelas: inst.classificacaoEstrelas };
            }

            const end = inst.endereco || {};

            return {
                id: inst.idInstituicao,
                codigo: inst.codigo,
                nome: inst.nome,
                telefone: inst.telefone,
                tipo: tipo,
                endereco: {
                    rua: end.rua || '',
                    numero: end.numero || '',
                    bairro: end.bairro || '',
                    cidade: end.cidade || '',
                    estado: end.estado || '', 
                    cep: end.cep || ''
                },
                detalhes: detalhes
            };
        }

        // --- 2. Renderização ---
        function renderizarTabela(lista) {
            const tbody = document.getElementById('tabelaInstituicoes');
            tbody.innerHTML = '';

            if (lista.length === 0) {
                document.getElementById('msgVazio').classList.remove('d-none');
                return;
            }

            lista.forEach(inst => {
                const tr = document.createElement('tr');
                const tipoFormatado = inst.tipo.charAt(0).toUpperCase() + inst.tipo.slice(1);
                const enderecoCurto = `${inst.endereco.rua}, ${inst.endereco.numero} - ${inst.endereco.cidade}/${inst.endereco.estado}`;

                tr.innerHTML = `
                    <td>${inst.codigo}</td>
                    <td class="fw-bold text-start">${inst.nome}</td>
                    <td><span class="badge bg-${getCorTipo(inst.tipo)}">${tipoFormatado}</span></td>
                    <td>${inst.telefone || '-'}</td>
                    <td class="text-start small text-muted">${enderecoCurto}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editarInstituicao(${inst.id})" title="Editar"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="excluirInstituicao(${inst.id})" title="Excluir"><i class="bi bi-trash"></i></button>
                        <button class="btn btn-sm btn-outline-secondary btn-action" onclick="buscarNoMapa(${inst.id})" title="Localizar Endereço"><i class="bi bi-geo-alt"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. Salvar (POST/PUT) - CORREÇÃO 1: Erros Detalhados ---
        async function salvarInstituicao(event) {
            event.preventDefault();
            
            const editId = document.getElementById('editId').value;
            const tipo = document.getElementById('tipoSelect').value;

            const payload = {
                codigo: parseInt(document.getElementById('codigo').value),
                nome: document.getElementById('nome').value,
                telefone: document.getElementById('telefone').value,
                endereco: {
                    cep: document.getElementById('cep').value,
                    rua: document.getElementById('rua').value,
                    numero: document.getElementById('numero').value,
                    bairro: document.getElementById('bairro').value,
                    cidade: document.getElementById('cidade').value,
                    estado: document.getElementById('estado').value
                }
            };

            let endpoint = "";
            if (tipo === 'creche') {
                endpoint = "/creche";
                payload.idadeMaximaAtendidaMeses = parseInt(document.getElementById('crecheIdade').value);
                payload.capacidade = parseInt(document.getElementById('crecheCapacidade').value);
            } else if (tipo === 'escola') {
                endpoint = "/escola";
                payload.numeroMatriculas = parseInt(document.getElementById('escolaMatriculas').value);
                payload.turno = document.getElementById('escolaTurno').value;
            } else if (tipo === 'hotel') {
                endpoint = "/hotel";
                payload.numeroQuartos = parseInt(document.getElementById('hotelQuartos').value);
                payload.classificacaoEstrelas = parseInt(document.getElementById('hotelEstrelas').value);
            }

            const method = editId ? "PUT" : "POST"; 
            // Se estiver editando, a URL é /api/instituicoes/{id}, se criando é /api/instituicoes/creche (exemplo)
            // Nota: Se o seu backend não suporta PUT em /api/instituicoes/{id} e requer o endpoint específico por tipo, ajuste aqui.
            // Vou assumir que criação usa o endpoint específico e edição usa o genérico ou específico com ID.
            // Para simplificar e evitar erros de rota no Spring, geralmente criação é específico.
            
            // Tenta usar a lógica de endpoint:
            let urlFinal = `${API_URL}${endpoint}`;
            if (editId) {
                // Se for edição, geralmente o ID vai na URL. Verifique se seu Controller suporta PUT no endpoint base.
                // Se não suportar, pode ser que precise ser POST mesmo para atualizar se a lógica for essa.
                // Vou manter a lógica padrão REST: PUT com ID.
                urlFinal = `${API_URL}/${editId}`; 
            }

            console.log("Enviando Payload:", JSON.stringify(payload));

            try {
                const response = await fetch(urlFinal, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("Instituição salva com sucesso!");
                    modalInstance.hide();
                    carregarDadosDoBanco();
                } else {
                    // CORREÇÃO 1: Lê a mensagem de erro real do backend
                    const errorText = await response.text();
                    console.error("Erro Backend:", errorText);
                    alert("Erro ao salvar:\n" + errorText);
                }
            } catch (error) {
                console.error(error);
                alert("Erro de conexão com o servidor.");
            }
        }

        // --- 4. Excluir (DELETE) ---
        async function excluirInstituicao(id) {
            if(confirm("Tem certeza que deseja excluir?")) {
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
                    if(response.ok || response.status === 204) {
                        carregarDadosDoBanco();
                    } else {
                        alert("Erro ao excluir.");
                    }
                } catch (error) {
                    alert("Erro de conexão.");
                }
            }
        }

        // --- 5. UI Helpers ---
        function abrirModalCriacao() {
            document.getElementById('formInstituicao').reset();
            document.getElementById('editId').value = '';
            document.getElementById('tituloModal').innerText = "Adicionar Instituição";
            document.getElementById('tipoSelect').disabled = false;
            toggleCamposEspecificos();
            modalInstance.show();
        }

        function editarInstituicao(id) {
            const inst = instituicoesCache.find(i => i.id === id);
            if (!inst) return;

            document.getElementById('editId').value = inst.id;
            document.getElementById('codigo').value = inst.codigo;
            document.getElementById('nome').value = inst.nome;
            document.getElementById('telefone').value = inst.telefone;
            
            document.getElementById('cep').value = inst.endereco.cep;
            document.getElementById('rua').value = inst.endereco.rua;
            document.getElementById('numero').value = inst.endereco.numero;
            document.getElementById('bairro').value = inst.endereco.bairro;
            document.getElementById('cidade').value = inst.endereco.cidade;
            document.getElementById('estado').value = inst.endereco.estado;

            const select = document.getElementById('tipoSelect');
            select.value = inst.tipo;
            select.disabled = true; 
            toggleCamposEspecificos();

            if (inst.tipo === 'creche') {
                document.getElementById('crecheIdade').value = inst.detalhes.idadeMax;
                document.getElementById('crecheCapacidade').value = inst.detalhes.capacidade;
            } else if (inst.tipo === 'escola') {
                document.getElementById('escolaMatriculas').value = inst.detalhes.matriculas;
                document.getElementById('escolaTurno').value = inst.detalhes.turno;
            } else if (inst.tipo === 'hotel') {
                document.getElementById('hotelQuartos').value = inst.detalhes.quartos;
                document.getElementById('hotelEstrelas').value = inst.detalhes.estrelas;
            }

            document.getElementById('tituloModal').innerText = "Editar Instituição";
            modalInstance.show();
        }

        function toggleCamposEspecificos() {
            const tipo = document.getElementById('tipoSelect').value;
            document.getElementById('camposCreche').style.display = 'none';
            document.getElementById('camposEscola').style.display = 'none';
            document.getElementById('camposHotel').style.display = 'none';

            if (tipo === 'creche') document.getElementById('camposCreche').style.display = 'block';
            if (tipo === 'escola') document.getElementById('camposEscola').style.display = 'block';
            if (tipo === 'hotel') document.getElementById('camposHotel').style.display = 'block';
        }

        function getCorTipo(tipo) {
            switch(tipo) {
                case 'creche': return 'info';
                case 'escola': return 'warning text-dark';
                case 'hotel': return 'primary';
                default: return 'secondary';
            }
        }

        function filtrarTabela() {
            const termo = document.getElementById('buscar').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaInstituicoes tr');
            linhas.forEach(linha => {
                const texto = linha.innerText.toLowerCase();
                linha.style.display = texto.includes(termo) ? '' : 'none';
            });
        }

        // --- 6. Mapa e Geocodificação (CORREÇÃO 3) ---
        function initMap() {
            map = L.map('map').setView([-14.2350, -51.9253], 4); // Centro do Brasil
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        async function buscarNoMapa(id) {
            const inst = instituicoesCache.find(i => i.id === id);
            if (!inst) return;

            const statusDiv = document.getElementById('statusMapa');
            statusDiv.innerHTML = `<div class="spinner-border spinner-border-sm text-primary"></div> Buscando: ${inst.endereco.rua}, ${inst.endereco.cidade}...`;

            // Monta a string de busca para a API do OpenStreetMap
            // Ex: "Rua das Flores, 123, São Paulo, SP, Brazil"
            const query = `${inst.endereco.rua}, ${inst.endereco.numero}, ${inst.endereco.bairro}, ${inst.endereco.cidade}, ${inst.endereco.estado}, Brazil`;
            
            try {
                // Chama a API Nominatim (Gratuita)
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;

                    // Remove marcador anterior se existir
                    if (currentMarker) map.removeLayer(currentMarker);

                    // Adiciona novo marcador e move o mapa
                    currentMarker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${inst.nome}</b><br>${inst.endereco.rua}, ${inst.endereco.numero}`)
                        .openPopup();

                    map.setView([lat, lon], 16); // Zoom aproximado
                    statusDiv.innerHTML = `<i class="bi bi-check-circle text-success"></i> Localizado: ${inst.nome}`;
                    
                    // Rola a tela até o mapa suavemente
                    document.getElementById('map').scrollIntoView({ behavior: 'smooth' });

                } else {
                    statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle text-warning"></i> Endereço não encontrado no mapa.`;
                    alert("O OpenStreetMap não conseguiu encontrar este endereço exato.\nTente verificar se o nome da rua e cidade estão corretos.");
                }

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<i class="bi bi-x-circle text-danger"></i> Erro na busca.`;
            }
        }
    </script>
  </body>
</html>
